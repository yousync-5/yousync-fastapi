# RQ (Redis Queue) ë„ì… ì‘ì—… ê³„íšì„œ

**ì‘ì—… ì¼ì**: 2025ë…„ 7ì›” 10ì¼  
**ì˜ˆìƒ ì†Œìš” ì‹œê°„**: 4-6ì‹œê°„  
**ëª©í‘œ**: í˜„ì¬ BackgroundTasks ë°©ì‹ì„ RQ ì‘ì—… íë¡œ ì „í™˜

## ğŸ¯ ì‘ì—… ëª©í‘œ

### í˜„ì¬ ìƒí™©
- **BackgroundTasks**: FastAPI í”„ë¡œì„¸ìŠ¤ ë‚´ì—ì„œ ë°±ê·¸ë¼ìš´ë“œ ì²˜ë¦¬
- **httpx ì§ì ‘ í†µì‹ **: ë¶„ì„ ì„œë²„ì™€ ì§ì ‘ HTTP í†µì‹ 
- **ì œí•œì  ë™ì‹œì„±**: í”„ë¡œì„¸ìŠ¤ ë‚´ ì²˜ë¦¬ë¡œ í™•ì¥ì„± ì œí•œ

### ëª©í‘œ ìƒí™©
- **RQ ì‘ì—… í**: Redis ê¸°ë°˜ ì§„ì§œ í ì‹œìŠ¤í…œ
- **Worker ë¶„ë¦¬**: ë³„ë„ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì‘ì—… ì²˜ë¦¬
- **í™•ì¥ ê°€ëŠ¥**: Worker ì—¬ëŸ¬ ê°œ ì‹¤í–‰ìœ¼ë¡œ ë™ì‹œ ì²˜ë¦¬

## ğŸ“‹ ì‘ì—… ë‹¨ê³„ë³„ ê³„íš

### Phase 1: í™˜ê²½ ì„¤ì • (30ë¶„)

#### 1.1 Redis ì„¤ì¹˜ ë° ì‹¤í–‰
```bash
# macOS
brew install redis
brew services start redis

# ì—°ê²° í…ŒìŠ¤íŠ¸
redis-cli ping
# ì‘ë‹µ: PONG
```

#### 1.2 Python íŒ¨í‚¤ì§€ ì„¤ì¹˜
```bash
cd back-end
pip install rq redis rq-dashboard
pip freeze > requirements.txt
```

#### 1.3 í™˜ê²½ ë³€ìˆ˜ ì¶”ê°€
```bash
# .env íŒŒì¼ì— ì¶”ê°€
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
USE_RQ_QUEUE=true  # RQ ì‚¬ìš© ì—¬ë¶€ ì œì–´
```

### Phase 2: RQ ì„¤ì • íŒŒì¼ ìƒì„± (30ë¶„)

#### 2.1 Redis í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
```python
# back-end/redis_client.py ìƒì„±
import redis
import os
from rq import Queue

# Redis ì—°ê²°
redis_client = redis.Redis(
    host=os.getenv('REDIS_HOST', 'localhost'),
    port=int(os.getenv('REDIS_PORT', 6379)),
    db=int(os.getenv('REDIS_DB', 0)),
    decode_responses=True
)

# í ìƒì„±
audio_analysis_queue = Queue('audio_analysis', connection=redis_client)
high_priority_queue = Queue('high_priority', connection=redis_client)

# ì—°ê²° í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
def test_redis_connection():
    try:
        redis_client.ping()
        print("âœ… Redis ì—°ê²° ì„±ê³µ")
        return True
    except Exception as e:
        print(f"âŒ Redis ì—°ê²° ì‹¤íŒ¨: {e}")
        return False
```

#### 2.2 ì‘ì—… í•¨ìˆ˜ ë””ë ‰í† ë¦¬ ìƒì„±
```bash
mkdir back-end/tasks
touch back-end/tasks/__init__.py
```

### Phase 3: ì‘ì—… í•¨ìˆ˜ êµ¬í˜„ (1-2ì‹œê°„)

#### 3.1 ê¸°ì¡´ ì½”ë“œ ë¶„ë¦¬
```python
# back-end/tasks/audio_analysis.py ìƒì„±
import json
import logging
from typing import Dict, Any
from database import SessionLocal
from models import AnalysisResult

def process_audio_analysis(job_id: str, s3_url: str, token_info: Dict[str, Any]):
    """
    RQ ì‘ì—… í•¨ìˆ˜: ê¸°ì¡´ process_in_background ë¡œì§ì„ ê·¸ëŒ€ë¡œ ì´ë™
    """
    # ê¸°ì¡´ process_in_background í•¨ìˆ˜ ë‚´ìš©ì„ ì—¬ê¸°ë¡œ ì´ë™
    # ìƒˆë¡œìš´ DB ì„¸ì…˜ ìƒì„±
    # S3 ì—…ë¡œë“œëŠ” ì´ë¯¸ ì™„ë£Œëœ ìƒíƒœ
    # ë¶„ì„ ì„œë²„ ìš”ì²­ ë° ì›¹í›… ì²˜ë¦¬
    pass
```

#### 3.2 í—¬í¼ í•¨ìˆ˜ë“¤ ì´ë™
```python
# ê¸°ì¡´ user_audio_router.pyì˜ í•¨ìˆ˜ë“¤ì„ tasks ëª¨ë“ˆë¡œ ì´ë™
- send_analysis_request_async()
- update_analysis_result()
- ê¸°íƒ€ í—¬í¼ í•¨ìˆ˜ë“¤
```

### Phase 4: API ì—”ë“œí¬ì¸íŠ¸ ìˆ˜ì • (1-2ì‹œê°„)

#### 4.1 user_audio_router.py ìˆ˜ì •
```python
# ê¸°ì¡´ BackgroundTasks ë°©ì‹
background_tasks.add_task(process_in_background, s3_client)

# RQ ë°©ì‹ìœ¼ë¡œ ë³€ê²½
from redis_client import audio_analysis_queue
from tasks.audio_analysis import process_audio_analysis

# í™˜ê²½ ë³€ìˆ˜ë¡œ ë°©ì‹ ì„ íƒ
if os.getenv('USE_RQ_QUEUE', 'false').lower() == 'true':
    # RQ ë°©ì‹
    job = audio_analysis_queue.enqueue(
        process_audio_analysis,
        job_id=job_id,
        s3_url=s3_url,
        token_info=token_info_dict,
        job_timeout='15m',
        retry=3
    )
else:
    # ê¸°ì¡´ BackgroundTasks ë°©ì‹ (í•˜ìœ„ í˜¸í™˜)
    background_tasks.add_task(process_in_background, s3_client)
```

#### 4.2 ìƒˆë¡œìš´ API ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€
```python
# í ìƒíƒœ ì¡°íšŒ
@router.get("/queue/status")
def get_queue_status():
    return {
        "audio_analysis": {
            "length": len(audio_analysis_queue),
            "failed_count": audio_analysis_queue.failed_job_registry.count
        }
    }

# ì‘ì—… ì·¨ì†Œ
@router.delete("/jobs/{job_id}/cancel")
def cancel_job(job_id: str):
    # RQ ì‘ì—… ì·¨ì†Œ ë¡œì§
    pass
```

### Phase 5: Worker ì„¤ì • (30ë¶„)

#### 5.1 Worker ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
```python
# back-end/workers/rq_worker.py ìƒì„±
import os
import sys
from rq import Worker
from redis_client import redis_client

def run_worker():
    queue_names = ['high_priority', 'audio_analysis']
    worker = Worker(queue_names, connection=redis_client)
    worker.work(with_scheduler=True)

if __name__ == '__main__':
    run_worker()
```

#### 5.2 ì‹¤í–‰ ëª…ë ¹ì–´ ìŠ¤í¬ë¦½íŠ¸
```bash
# start_worker.sh ìƒì„±
#!/bin/bash
cd back-end
python workers/rq_worker.py
```

### Phase 6: í…ŒìŠ¤íŠ¸ ë° ê²€ì¦ (1-2ì‹œê°„)

#### 6.1 ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
```python
# í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤
1. ì˜¤ë””ì˜¤ ì—…ë¡œë“œ â†’ RQ íì— ì‘ì—… ì¶”ê°€ í™•ì¸
2. Worker ì‹¤í–‰ â†’ ì‘ì—… ì²˜ë¦¬ í™•ì¸
3. ë¶„ì„ ì™„ë£Œ â†’ ì›¹í›… ìˆ˜ì‹  í™•ì¸
4. SSE ìŠ¤íŠ¸ë¦¼ â†’ ì‹¤ì‹œê°„ ìƒíƒœ ì—…ë°ì´íŠ¸ í™•ì¸
```

#### 6.2 ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
```python
# ë™ì‹œ ìš”ì²­ í…ŒìŠ¤íŠ¸
- ì—¬ëŸ¬ ì˜¤ë””ì˜¤ íŒŒì¼ ë™ì‹œ ì—…ë¡œë“œ
- íì— ìˆœì„œëŒ€ë¡œ ìŒ“ì´ëŠ”ì§€ í™•ì¸
- Workerê°€ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ”ì§€ í™•ì¸
```

#### 6.3 ì—ëŸ¬ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸
```python
# ì‹¤íŒ¨ ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸
- Redis ì—°ê²° ì‹¤íŒ¨
- Worker í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
- ë¶„ì„ ì„œë²„ ì‘ë‹µ ì‹¤íŒ¨
- ì¬ì‹œë„ ë©”ì»¤ë‹ˆì¦˜ ë™ì‘ í™•ì¸
```

## ğŸ”§ ì‹¤í–‰ ë°©ë²•

### ê°œë°œ í™˜ê²½ ì‹¤í–‰
```bash
# í„°ë¯¸ë„ 1: FastAPI ì„œë²„
cd back-end
uvicorn main:app --reload

# í„°ë¯¸ë„ 2: RQ Worker
cd back-end
python workers/rq_worker.py

# í„°ë¯¸ë„ 3: RQ Dashboard (ì„ íƒì‚¬í•­)
rq-dashboard --redis-url redis://localhost:6379
```

### í”„ë¡œë•ì…˜ ë°°í¬
```bash
# systemd ì„œë¹„ìŠ¤ ë“±ë¡ ë˜ëŠ” Docker ì»¨í…Œì´ë„ˆë¡œ ì‹¤í–‰
# Worker í”„ë¡œì„¸ìŠ¤ ì—¬ëŸ¬ ê°œ ì‹¤í–‰ìœ¼ë¡œ ë™ì‹œ ì²˜ë¦¬ í–¥ìƒ
```

## ğŸ“Š ì˜ˆìƒ ê°œì„  íš¨ê³¼

### ì„±ëŠ¥ ê°œì„ 
- **ë™ì‹œ ì²˜ë¦¬**: Worker ìˆ˜ë§Œí¼ ë™ì‹œ ì‘ì—… ê°€ëŠ¥
- **ë©”ëª¨ë¦¬ íš¨ìœ¨**: ì‘ì—…ì´ ë³„ë„ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì‹¤í–‰
- **ì‘ë‹µ ì‹œê°„**: í ì¶”ê°€ í›„ ì¦‰ì‹œ ì‘ë‹µ (ê¸°ì¡´ê³¼ ë™ì¼)

### ì•ˆì •ì„± ê°œì„ 
- **ì¬ì‹œë„**: ìë™ 3íšŒ ì¬ì‹œë„
- **íƒ€ì„ì•„ì›ƒ**: 15ë¶„ í›„ ìë™ ì‹¤íŒ¨ ì²˜ë¦¬
- **ëª¨ë‹ˆí„°ë§**: RQ Dashboardë¡œ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§

### í™•ì¥ì„± ê°œì„ 
- **ìˆ˜í‰ í™•ì¥**: Worker í”„ë¡œì„¸ìŠ¤ ì¶”ê°€ë¡œ ì²˜ë¦¬ëŸ‰ ì¦ê°€
- **ìš°ì„ ìˆœìœ„**: ê¸´ê¸‰ ì‘ì—… ìš°ì„  ì²˜ë¦¬ ê°€ëŠ¥
- **ë°°ì¹˜ ì²˜ë¦¬**: ëŒ€ëŸ‰ ì‘ì—… íš¨ìœ¨ì  ì²˜ë¦¬

## ğŸš¨ ì£¼ì˜ì‚¬í•­

### 1. í•˜ìœ„ í˜¸í™˜ì„±
- í™˜ê²½ ë³€ìˆ˜ `USE_RQ_QUEUE=false`ë¡œ ê¸°ì¡´ ë°©ì‹ ìœ ì§€ ê°€ëŠ¥
- ë¬¸ì œ ë°œìƒì‹œ ì¦‰ì‹œ ë¡¤ë°± ê°€ëŠ¥

### 2. Redis ì˜ì¡´ì„±
- Redis ì„œë²„ ì¥ì• ì‹œ í ì‹œìŠ¤í…œ ì „ì²´ ì˜í–¥
- Redis ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§ í•„ìš”

### 3. Worker í”„ë¡œì„¸ìŠ¤ ê´€ë¦¬
- Worker í”„ë¡œì„¸ìŠ¤ ìë™ ì¬ì‹œì‘ ì„¤ì • í•„ìš”
- í”„ë¡œë•ì…˜ì—ì„œëŠ” systemd ë˜ëŠ” Dockerë¡œ ê´€ë¦¬

## ğŸ“… ì‘ì—… ì¼ì •

| ì‹œê°„ | ì‘ì—… ë‚´ìš© | ì˜ˆìƒ ì†Œìš” ì‹œê°„ |
|------|-----------|----------------|
| 09:00-09:30 | í™˜ê²½ ì„¤ì • (Redis ì„¤ì¹˜, íŒ¨í‚¤ì§€ ì„¤ì¹˜) | 30ë¶„ |
| 09:30-10:00 | RQ ì„¤ì • íŒŒì¼ ìƒì„± | 30ë¶„ |
| 10:00-12:00 | ì‘ì—… í•¨ìˆ˜ êµ¬í˜„ (ê¸°ì¡´ ì½”ë“œ ì´ë™) | 2ì‹œê°„ |
| 13:00-15:00 | API ì—”ë“œí¬ì¸íŠ¸ ìˆ˜ì • | 2ì‹œê°„ |
| 15:00-15:30 | Worker ì„¤ì • | 30ë¶„ |
| 15:30-17:30 | í…ŒìŠ¤íŠ¸ ë° ê²€ì¦ | 2ì‹œê°„ |

**ì´ ì˜ˆìƒ ì‹œê°„**: 7ì‹œê°„ (ì—¬ìœ ì‹œê°„ í¬í•¨)

## ğŸ¯ ì„±ê³µ ê¸°ì¤€

- âœ… ê¸°ì¡´ ê¸°ëŠ¥ ëª¨ë‘ ì •ìƒ ë™ì‘
- âœ… RQ íì— ì‘ì—…ì´ ì •ìƒì ìœ¼ë¡œ ì¶”ê°€ë¨
- âœ… Workerê°€ ì‘ì—…ì„ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬
- âœ… ì‹¤íŒ¨ì‹œ ìë™ ì¬ì‹œë„ ë™ì‘
- âœ… RQ Dashboardì—ì„œ ëª¨ë‹ˆí„°ë§ ê°€ëŠ¥
- âœ… ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ ë¡¤ë°± ê°€ëŠ¥

---

**ì‘ì—… ì‹œì‘ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸**:
- [ ] Redis ì„¤ì¹˜ ë° ì‹¤í–‰ í™•ì¸
- [ ] ê¸°ì¡´ ì½”ë“œ ë°±ì—… ì™„ë£Œ
- [ ] í…ŒìŠ¤íŠ¸ í™˜ê²½ ì¤€ë¹„
- [ ] ë¡¤ë°± ê³„íš ìˆ˜ë¦½

**ì‘ì—… ì™„ë£Œ í›„ ì²´í¬ë¦¬ìŠ¤íŠ¸**:
- [ ] ëª¨ë“  ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ í†µê³¼
- [ ] ì„±ëŠ¥ ê°œì„  í™•ì¸
- [ ] ë¬¸ì„œ ì—…ë°ì´íŠ¸
- [ ] íŒ€ì› ê³µìœ  ë° êµìœ¡
